From e94d2e706531af3efd0235f1d8c7c6fdf31ab5eb Mon Sep 17 00:00:00 2001
From: Xiaotian Wu <wuxiaotian@loongson.cn>
Date: Mon, 13 Nov 2023 10:14:01 +0800
Subject: [PATCH] add loongarch64 support

---
 util/archutil/Dockerfile                  |  6 ++++--
 util/archutil/detect.go                   | 10 ++++++++++
 util/archutil/fixtures/exit.loongarch64.s |  6 ++++++
 util/archutil/loong64_binary.go           |  9 +++++++++
 util/archutil/loong64_check.go            |  8 ++++++++
 util/archutil/loong64_check_loong64.go    |  8 ++++++++
 6 files changed, 45 insertions(+), 2 deletions(-)
 create mode 100644 util/archutil/fixtures/exit.loongarch64.s
 create mode 100644 util/archutil/loong64_binary.go
 create mode 100644 util/archutil/loong64_check.go
 create mode 100644 util/archutil/loong64_check_loong64.go

diff --git a/util/archutil/Dockerfile b/util/archutil/Dockerfile
index 2b24b230b..df161291b 100644
--- a/util/archutil/Dockerfile
+++ b/util/archutil/Dockerfile
@@ -8,7 +8,8 @@ RUN apt-get update && apt-get --no-install-recommends install -y \
   binutils-s390x-linux-gnu \
   binutils-powerpc64le-linux-gnu \
   binutils-mips64el-linux-gnuabi64 \
-  binutils-mips64-linux-gnuabi64
+  binutils-mips64-linux-gnuabi64 \
+  binutils-loongarch64-linux-gnu
 WORKDIR /src
 
 
@@ -64,9 +65,10 @@ COPY --from=exit-ppc64 /src/exit ppc64
 COPY --from=exit-ppc64le /src/exit ppc64le
 COPY --from=exit-mips64le /src/exit mips64le
 COPY --from=exit-mips64 /src/exit mips64
+COPY --from=exit-loong64 /src/exit loong64
 COPY generate.go .
 
-RUN go run generate.go amd64 386 arm64 arm riscv64 s390x ppc64 ppc64le mips64le mips64 && ls -l
+RUN go run generate.go amd64 386 arm64 arm riscv64 s390x ppc64 ppc64le mips64le mips64 loong64 && ls -l
 
 
 FROM scratch
diff --git a/util/archutil/detect.go b/util/archutil/detect.go
index 782644127..b36726c92 100644
--- a/util/archutil/detect.go
+++ b/util/archutil/detect.go
@@ -78,6 +78,11 @@ func SupportedPlatforms(noCache bool) []ocispecs.Platform {
 			arr = append(arr, linux(p))
 		}
 	}
+	if p := "loong64"; def.Architecture != p {
+                if _, err := loong64Supported(); err == nil {
+                        arr = append(arr, linux(p))
+                }
+        }
 	if p := "arm"; def.Architecture != p {
 		if _, err := armSupported(); err == nil {
 			p := linux("arm")
@@ -144,6 +149,11 @@ func WarnIfUnsupported(pfs []ocispecs.Platform) {
 					printPlatformWarning(p, err)
 				}
 			}
+			if p.Architecture == "loong64" {
+                                if _, err := loong64Supported(); err != nil {
+                                        printPlatformWarning(p, err)
+                                }
+                        }
 			if p.Architecture == "arm" {
 				if _, err := armSupported(); err != nil {
 					printPlatformWarning(p, err)
diff --git a/util/archutil/fixtures/exit.loongarch64.s b/util/archutil/fixtures/exit.loongarch64.s
new file mode 100644
index 000000000..478cd622c
--- /dev/null
+++ b/util/archutil/fixtures/exit.loongarch64.s
@@ -0,0 +1,6 @@
+	.global _start
+	.text
+_start:
+	li.w $a0,0
+	li.w $a7,93
+	syscall 0
diff --git a/util/archutil/loong64_binary.go b/util/archutil/loong64_binary.go
new file mode 100644
index 000000000..fa85a4553
--- /dev/null
+++ b/util/archutil/loong64_binary.go
@@ -0,0 +1,9 @@
+//go:build !loong64
+// +build !loong64
+
+package archutil
+
+// This file is generated by running make inside the archutil package.
+// Do not edit manually.
+
+const Binaryloong64 = "\x1f\x8b\x08\x00\x00\x00\x00\x00\x02\xff\xaa\x77\xf5\x71\x63\x62\x64\x64\x80\x01\x26\x06\x08\x6f\x03\x03\x83\x02\x88\x76\x80\x8a\x5f\x80\xd2\xcc\x60\x31\x0b\x06\x26\x06\x07\x06\x66\x06\x26\x06\x90\x1a\x56\x06\x14\xa0\xc0\x88\x44\xef\x81\x0a\xc2\x68\x98\x81\x81\x4f\x4b\x52\xd8\x18\x88\x07\x02\x50\x9a\x85\x41\x94\x81\xbb\xa4\x91\x99\x81\x41\x9b\x81\x41\xaf\x38\xa3\xb8\xa4\xa8\x24\x31\x89\x41\xaf\x24\xb5\xa2\x84\x81\x0a\x80\x9b\x81\x01\xec\x27\x98\xdb\x60\xe1\xb0\x01\xca\xe7\x41\x53\xcf\x88\x85\xcf\x8c\xc5\x5c\x98\xff\x05\x09\xe8\x07\x04\x00\x00\xff\xff\x31\xd2\xf1\xb5\x90\x01\x00\x00"
diff --git a/util/archutil/loong64_check.go b/util/archutil/loong64_check.go
new file mode 100644
index 000000000..9bc966ce2
--- /dev/null
+++ b/util/archutil/loong64_check.go
@@ -0,0 +1,8 @@
+//go:build !loong64
+// +build !loong64
+
+package archutil
+
+func loong64Supported() (string, error) {
+	return check("loong64", Binaryloong64)
+}
diff --git a/util/archutil/loong64_check_loong64.go b/util/archutil/loong64_check_loong64.go
new file mode 100644
index 000000000..b801c5938
--- /dev/null
+++ b/util/archutil/loong64_check_loong64.go
@@ -0,0 +1,8 @@
+//go:build loong64
+// +build loong64
+
+package archutil
+
+func loong64Supported() (string, error) {
+	return "", nil
+}
-- 
2.42.0

