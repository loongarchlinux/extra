# Maintainer: Lukas Fleischer <lfleischer@archlinux.org>
# Contributor: dorphell <dorphell@archlinux.org>
# Contributor: Dan McGee <dan@archlinux.org>
# Contributor: Alexander F. RÃ¸dseth <xyproto@archlinux.org>

pkgname=cvs
pkgver=1.11.23
pkgrel=15
pkgdesc='Source control'
arch=(loong64 x86_64)
url='https://cvs.nongnu.org/'
license=(GPL-2.0-or-later)
depends=(krb5)
makedepends=(tinyxxd)
optdepends=('openssh: for using cvs over ssh'
            'inetutils: for using cvs over rsh')
source=("https://ftp.gnu.org/non-gnu/cvs/source/stable/$pkgver/$pkgname-$pkgver.tar.bz2"
        cvs-1.11.19-abortabort.patch
        cvs-1.11.19-comp.patch
        cvs-1.11.19-extzlib.patch
        cvs-1.11.19-logmsg.patch
        cvs-1.11.19-netbsd-tag.patch
        cvs-1.11.19-tagname.patch
        cvs-1.11.19-tmp.patch
        cvs-1.11.21-diff-kk.patch
        cvs-1.11.21-diff.patch
        cvs-1.11.21-sort.patch
        cvs-1.11.23-cve-2010-3846.patch
        cvs-1.11.23-cvspass.patch
        cvs-1.11.23-doc-Add-mandatory-argument-to-sp.patch
        cvs-1.11.23-getline64.patch
        cvs-1.11.23-make_make_check_sanity_testing_verbose.patch
        cvs-1.11.23-Pass-compilation-with-Wformat-security.patch
        cvs-1.11.23-remove_undefined_date_from_cvs_1_header.patch
        cvs-1.11.23-sanity.patch)
b2sums=('73c01741793c74106be076c9f931a90e0eb8630e80375762d5add70d940a81837b4690e5963ef2a11a021402a157c48fbdb7770784f70a978359c18ad4356e98'
        '90ba80b9b2b2d927629f3ae0e04592908b57a4bd4bca1a57ac56d58396ce5a2c08f06db5e5e383659f658f92bdd55e49645e6937b935e2951fb004dd272fe14c'
        'e36e485ec8f5715b7135705d6f75fb3a4c0b19bf020b9ce41998e741f7a110fbfb700da7f8d977252a1461b047beba2f890ef4aaf8842fa1aea5c3f2a970705c'
        '0cae2a1ee2cb2f16b0eebecf8bebfead3c46dea178e8e485a1701b4bc06f459b96febdbedbdf48b5510ab51dc87008fe1d266890fbf8482c02ad634e0c54302f'
        'de066a0867f89ec52481bf190c2879d8e888b1faaa744d2ed18cfe66b2007d9a405350bdbf232e0c50e0d09629779a7dfd264862028070a13042a3c710c26dbe'
        'b4a47a749ce158aeb722fd17683b1abc00293c863b54290a48e0c2b6f220b937488cf0923e06d9687d884e665751a1e906eabcf58f26082e0aba624707544f85'
        'bcf4dbed4c7caf62c297bd71f6e9891b792ca1e78f38da0bc1d95931b0434aef51bd233884fc359d06b6d4b898e7c024d5a9ecb3d8d2711a60a64da1481ad03d'
        '876e0937d8c12426d4b07d7deb07b202e1aebfb2eae31d68f3c7356a5c52c6c33623118c9b3aa1f3a105b0e6cc0887e1bd5fd5d8bf3078f934a64421ec3ab88a'
        '3a9fe195c03471049874d6a97353c30aa1f0ec40504d0531dea332f731c3d5034548c60bfd5b09f33a72fe9bb72035e5f1c2d8a02b0908c8b6284b69b75b769d'
        '0e58ecc574cf47b2e2b5bc7da105a3efd8c718cfa58e9acfccc0f1d8d7ce0cc25bac00b750ac89011448da60358fae4c0b84e6310453a297c54399e6f6ca1008'
        '7f617e1de7d8b9ffcc5ca6c54824765105b7a3300ba313e46eaef5e75dd31df461bac6699f33e075048c14d1597e15c8627adef41de10e24be382e8b3c689f96'
        'd2c002046297c4bfea3655d1e11a7cca1265542f5e4832707f1a0206e4da5b406af1fae549b53487ef8f9c2c5f288bfeffc8829d3626eff9caf2ab0fd565529c'
        '16f49030e303375a59e5dc8eddc085453e7a0901848de2532e53375c7da9fa68d6724f8f610b19f4e76d1178f2b2305465f408974f536e77850dadf392b672f7'
        '8406bdc0a0dc948bfe73fed36892bc3e7bb517557854dbde3924600ce5cf8cb703cca2c1d9d469d909fb94cc0bca52536d4bccbc22a28a9acb0080633ce542e2'
        '39c54b7c718fcc4af9242d8fd06ba78c9496ad3fd66d131168124b4107f9c828fe846819a527f052400cf03e40c3952b0306eb11e08d8414b64f5b4ae7d84eab'
        'c790f23a7a3c632721af65952e394cc0e42bcd8d0018f4b0e1b370aac4b06cfe5cd64e22ed0870ec5a6eabee1bff42bb90324ab84aa32109f6d07cb4f8ee0b23'
        '8d55d4452a49349d95f3cce4eaa79845e3d7338d32f6f8b6af67697dfba61abbbb3bf4c034f8003e00c0abc21708430437671a0f138da2224c33ea3ec5f0353a'
        '6502722ec9f3ea711d0c3ce3cc525bbd930cd64d9e1b9be1ef3b5a768cd57d98c29560c097814e5ac9f4c1e09b804b3cfcfe580d63196deadf0e17cf0786fc66'
        'e4a17d12810a3b73dc4687c9935e2d2664d3c944e55c9e1fa9102ec3c37b0a1e39c76c75b5ed233f73852bca0ca3fda878ae628140c0296781a157e6b0633fb6')

build() {
  cd $pkgname-$pkgver
  unset EDITOR VISUAL
  patch -Np1 -i ../cvs-1.11.19-extzlib.patch
  patch -Np1 -i ../cvs-1.11.23-getline64.patch
  # CVE-2010-3864, https://www.redhat.com/security/data/cve/CVE-2010-3846.html
  patch -Np1 -i ../cvs-1.11.23-cve-2010-3846.patch
  patch -Np1 -i ../cvs-1.11.19-abortabort.patch
  patch -Np1 -i ../cvs-1.11.19-comp.patch
  patch -Np1 -i ../cvs-1.11.19-netbsd-tag.patch
  patch -Np1 -i ../cvs-1.11.19-tagname.patch
  patch -Np1 -i ../cvs-1.11.19-tmp.patch
  patch -Np1 -i ../cvs-1.11.21-diff-kk.patch
  patch -Np1 -i ../cvs-1.11.21-diff.patch
  patch -Np1 -i ../cvs-1.11.21-sort.patch
  patch -Np1 -i ../cvs-1.11.23-cvspass.patch
  patch -Np1 -i ../cvs-1.11.19-logmsg.patch
  patch -Np1 -i ../cvs-1.11.23-doc-Add-mandatory-argument-to-sp.patch
  patch -Np1 -i ../cvs-1.11.23-make_make_check_sanity_testing_verbose.patch
  patch -Np1 -i ../cvs-1.11.23-Pass-compilation-with-Wformat-security.patch
  patch -Np1 -i ../cvs-1.11.23-remove_undefined_date_from_cvs_1_header.patch
  patch -Np1 -i ../cvs-1.11.23-sanity.patch
  sed -i -e 's/AM_CONFIG_HEADER/AC_CONFIG_HEADERS/' configure.in
  find . -type f -name Makefile.am -exec sed -i -e 's/^INCLUDES/AM_CPPFLAGS/' {} +
  touch vi
  chmod +x vi
  export PATH="$PATH:."
  AUTOMAKE='automake --add-missing' autoreconf
  ./configure --prefix=/usr
  make
}

package() {
  DESTDIR="$pkgdir" make -C $pkgname-$pkgver install
  rm "$pkgdir/usr/share/info/dir"
}
