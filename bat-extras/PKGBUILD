# Maintainer: George Rawlinson <grawlinson@archlinux.org>

pkgname=bat-extras
pkgver=2024.02.12
pkgrel=1
pkgdesc='Bash scripts that integrate bat with various command line tools'
arch=('any')
url='https://github.com/eth-p/bat-extras'
license=('MIT')
depends=(
  'bat'
  'bash'
  'git'
  'ripgrep'
  'man'
)
makedepends=('shfmt')
checkdepends=('fish')
optdepends=(
  'ncurses: optional for batdiff script'
  'git-delta: optional for batdiff script'
  'fzf: optional for batman script'
  'exa: optional for batpipe script'
  'entr: optional for batwatch script'
  'prettier: various code formatting for prettybat script'
  'shfmt: bash formatting for prettybat script'
  'rustfmt: Rust formatting for prettybat script'
  'clang: C / C++ / Objective-C formatting for prettybat script'
  'python-black: Python formatting for prettybat script'
)
source=(
  "git+https://github.com/eth-p/bat-extras.git#tag=v$pkgver"
  'github.com-eth-p-best::git+https://github.com/eth-p/best.git'
  'github.com-eth-p-best-tests::git+https://github.com/eth-p/best-tests.git'
)
b2sums=('ae3e5824e1c48cfee44dcfc5b51d391a7efff1088f33496a443e37c81ee479e556395724ac44b765be312922c9312f6f07030868912b9a79aa20bf1d6c0f1088'
        'SKIP'
        'SKIP')

prepare(){
  cd "$pkgname"

  # setup submodules
  git submodule init
  git config submodule.best.url "$srcdir/github.com-eth-p-best"
  git -c protocol.file.allow=always submodule update

  pushd .test-framework
  git submodule init
  git config submodule.best-tests.url "$srcdir/github.com-eth-p-best-tests"
  git -c protocol.file.allow=always submodule update
  popd

  # fix incorrect version string using commit date
  # https://github.com/eth-p/bat-extras/issues/68
  git show --no-patch --format=%cd --date=format:%Y.%m.%d > version.txt
}

check() {
  cd "$pkgname"

  ./test.sh --verbose --strict --snapshot:show
}

package() {
  cd "$pkgname"

  # scripts
  ./build.sh \
    --prefix="$pkgdir/usr" \
    --install

  # documentation
  install -vDm644 -t "$pkgdir/usr/share/doc/$pkgname" \
    CONTRIBUTING.md README.md doc/*

  # man pages
  install -vDm644 -t "$pkgdir/usr/share/man/man1" man/*

  # license
  install -vDm644 -t "$pkgdir/usr/share/licenses/$pkgname" LICENSE.md
}
